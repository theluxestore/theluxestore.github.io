<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luxe Store — Admin</title>
  <style>
    body{background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;padding:20px}
    .container{max-width:1100px;margin:0 auto}
    h1{color:#ffd700}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left}
    th{color:#e6c200}
    button{background:#ffd700;color:#000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn-danger{background:#c33;color:#fff}
    .small{font-size:13px;color:#bbb}
    .flex{display:flex;gap:8px;align-items:center}
    #filters{margin-top:10px;display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin Panel — The Luxe Store</h1>
    <div class="small">Manage orders — view items, update status, delete, export CSV, total sales</div>

    <div id="filters">
      <label>Filter status:
        <select id="statusFilter">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="shipped">Shipped</option>
          <option value="completed">Completed</option>
        </select>
      </label>
      <button onclick="loadOrders()">Apply</button>
      <div style="margin-left:auto;" class="small">Total sales shown for <strong id="salesStatus">All</strong></div>
      <button onclick="exportCSV()" style="margin-left:8px">Export CSV</button>
    </div>

    <div id="ordersWrap"></div>
    <div style="margin-top:14px" class="small">Tip: Click "View" to see order items.</div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ---------- CONFIG ----------
    const SUPABASE_URL = 'https://meqbcuidksqwdmaqwvwc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lcWJjdWlka3Nxd2RtYXF3dndjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjU2MjMsImV4cCI6MjA3NjAwMTYyM30.HYdIGrRMwlOkiQkYBsUcIvPeVF2oAAUNPj8V-8PKuvs';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Simple demo password (change this!)
    const ADMIN_PASSWORD = 'admin123';

    // Ask for password
    (function askPass(){
      const p = prompt('Enter admin password:');
      if(!p || p !== ADMIN_PASSWORD){
        alert('Access denied.');
        document.body.innerHTML = '<h2 style="color:#ff8080">Access denied — wrong password</h2>';
        throw new Error('Admin auth failed');
      }
    })();

    // ---------- Load & Render Orders ----------
    async function loadOrders(){
      const filter = document.getElementById('statusFilter').value;
      let query = supabase.from('orders').select('*').order('created_at', { ascending: false });
      if(filter !== 'all') query = query.eq('status', filter);
      const { data, error } = await query;
      if(error){ console.error(error); alert('Error loading orders'); return; }
      renderOrders(data || []);
      // Show total sales for this filter
      const total = (data || []).reduce((s,o)=> s + Number(o.total || 0), 0);
      document.getElementById('salesStatus').innerText = filter === 'all' ? 'All' : filter;
      // show total nicely
      const el = document.getElementById('ordersWrap');
      const html = <div style="margin-top:12px;color:#ffd">${(data||[]).length} order(s) — Total sum: Rs ${total}</div>; 
      // insert above table
      if(el) el.insertAdjacentHTML('afterbegin', html);
    }

    function renderOrders(orders){
      const wrap = document.getElementById('ordersWrap');
      wrap.innerHTML = '';
      if(!orders || orders.length === 0){ wrap.innerHTML = '<div class="small" style="margin-top:10px">No orders found.</div>'; return; }

      let html = '<table><thead><tr><th>ID</th><th>Customer</th><th>Total (Rs)</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
      orders.forEach(o=>{
        html += `<tr id="row-${o.id}">
          <td>${o.id}</td>
          <td>${escapeHtml(o.customer_name||'—')}<div class="small">${escapeHtml(o.customer_email||'')}</div></td>
          <td>${o.total}</td>
          <td>
            <select onchange="updateStatus(${o.id}, this.value)">
              <option value="pending" ${o.status==='pending'?'selected':''}>Pending</option>
              <option value="shipped" ${o.status==='shipped'?'selected':''}>Shipped</option>
              <option value="completed" ${o.status==='completed'?'selected':''}>Completed</option>
            </select>
          </td>
          <td>${new Date(o.created_at).toLocaleString()}</td>
          <td class="flex">
            <button onclick='viewItems(${o.id})'>View</button>
            <button class="btn-danger" onclick="deleteOrder(${o.id})">Delete</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    // ---------- Actions ----------
    async function viewItems(orderId){
      const { data, error } = await supabase.from('orders').select('items').eq('id', orderId).single();
      if(error){ console.error(error); alert('Error fetching items'); return; }
      const items = data.items || [];
      let txt = Order ${orderId} items:\n\n;
      items.forEach(it => {
        txt += ${it.name} — Rs ${it.price} x ${it.qty}\n;
      });
      alert(txt);
    }

    async function updateStatus(orderId, newStatus){
      const { data, error } = await supabase.from('orders').update({ status: newStatus }).eq('id', orderId).select();
      if(error){ console.error(error); alert('Update failed'); return; }
      alert('Status updated');
      loadOrders();
    }

    async function deleteOrder(orderId){
      if(!confirm('Delete order #' + orderId + '?')) return;
      const { error } = await supabase.from('orders').delete().eq('id', orderId);
      if(error){ console.error(error); alert('Delete failed'); return; }
      document.getElementById('row-' + orderId).remove();
      alert('Deleted');
    }

    // Export CSV
    function exportCSV(){
      // read currently displayed rows in table
      const rows = Array.from(document.querySelectorAll('#ordersWrap table tbody tr'));
      if(rows.length===0){ alert('No orders to export'); return; }
      const csv = [];
      csv.push(['id','customer_name','customer_email','status','total','created_at','items'].join(','));
      rows.forEach(r=>{
        const id = r.children[0].innerText.trim();
        const cust = r.children[1].innerText.replace(/\n/g,' ').replace(/,/g,' ').trim();
        const total = r.children[2].innerText.trim();
        const status = r.children[3].querySelector('select').value;
        const date = r.children[4].innerText.trim();
        // fetch items from DOM not present — instead fetch from DB (async) - but to keep simple we'll get from DB then build CSV
        csv.push([id, "${cust}", status, total, date].join(','));
      });
      const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'orders_export.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // Utility: escape HTML
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // Load on open
    loadOrders();
  </script>
</body>
</html>
